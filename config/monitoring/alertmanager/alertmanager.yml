# =============================================================================
# Alertmanager Configuration for Kraken Trading Bot
# =============================================================================
# This configuration handles alert routing and notifications.
# Supports: Discord, Slack, Email, PagerDuty, and webhooks
# =============================================================================

global:
    # How long to wait before sending a notification about new alerts
    resolve_timeout: 5m

    # SMTP settings for email notifications (optional)
    # smtp_smarthost: 'smtp.gmail.com:587'
    # smtp_from: 'alertmanager@yourdomain.com'
    # smtp_auth_username: 'your-email@gmail.com'
    # smtp_auth_password: 'your-app-password'

# Templates for notifications (optional custom templates)
templates:
    - "/etc/alertmanager/templates/*.tmpl"

# Route tree for alert routing
route:
    # Default receiver
    receiver: "discord-critical"

    # Group alerts by these labels
    group_by: ["alertname", "service", "severity"]

    # How long to wait before sending a group notification
    group_wait: 30s

    # How long to wait before sending notification about new alerts in a group
    group_interval: 5m

    # How long to wait before re-sending a notification
    repeat_interval: 4h

    # Child routes for specific alert routing
    routes:
        # Critical alerts - immediate notification
        - match:
              severity: critical
          receiver: "discord-critical"
          group_wait: 10s
          group_interval: 1m
          repeat_interval: 1h
          continue: true

        # Warning alerts - standard notification
        - match:
              severity: warning
          receiver: "discord-warning"
          group_wait: 1m
          group_interval: 5m
          repeat_interval: 4h

        # Info alerts - low priority
        - match:
              severity: info
          receiver: "discord-info"
          group_wait: 5m
          group_interval: 15m
          repeat_interval: 12h

        # Trading-specific alerts
        - match:
              service: trading-bot
          receiver: "discord-trading"
          group_wait: 30s
          group_interval: 2m
          repeat_interval: 2h

        # Optimizer alerts
        - match:
              service: optimizer
          receiver: "discord-optimizer"
          group_wait: 5m
          group_interval: 15m
          repeat_interval: 6h

# Inhibition rules - prevent certain alerts when others are firing
inhibit_rules:
    # If the bot is down, inhibit WebSocket alerts
    - source_match:
          alertname: "TradingBotDown"
      target_match:
          alertname: "WebSocketDisconnected"
      equal: ["instance"]

    # If Redis is down, inhibit related bot state alerts
    - source_match:
          alertname: "RedisDown"
      target_match_re:
          alertname: ".*State.*"

    # Critical alerts inhibit warnings of the same type
    - source_match:
          severity: "critical"
      target_match:
          severity: "warning"
      equal: ["alertname", "service"]

# Receivers define notification destinations
# Note: All alerts are routed through the discord-webhook adapter service
# which converts Alertmanager webhooks to Discord embed format
receivers:
    # Discord webhook for critical alerts
    - name: "discord-critical"
      webhook_configs:
          - url: "http://discord-webhook:9095/webhook"
            send_resolved: true
            http_config:
                follow_redirects: true

    # Discord webhook for warning alerts
    - name: "discord-warning"
      webhook_configs:
          - url: "http://discord-webhook:9095/webhook"
            send_resolved: true

    # Discord webhook for info alerts
    - name: "discord-info"
      webhook_configs:
          - url: "http://discord-webhook:9095/webhook"
            send_resolved: false

    # Discord webhook for trading alerts
    - name: "discord-trading"
      webhook_configs:
          - url: "http://discord-webhook:9095/webhook"
            send_resolved: true

    # Discord webhook for optimizer alerts
    - name: "discord-optimizer"
      webhook_configs:
          - url: "http://discord-webhook:9095/webhook"
            send_resolved: true

    # Null receiver (for silencing)
    - name: "null"

    # Email receiver (optional - uncomment and configure)
    # - name: 'email'
    #   email_configs:
    #     - to: 'your-email@example.com'
    #       send_resolved: true
    #       headers:
    #         Subject: '{{ template "email.default.subject" . }}'

    # Slack receiver (optional - uncomment and configure)
    # - name: 'slack'
    #   slack_configs:
    #     - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
    #       channel: '#kraken-alerts'
    #       send_resolved: true
    #       title: '{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }} - {{ .CommonLabels.alertname }}'
    #       text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'

    # PagerDuty receiver (optional - uncomment and configure)
    # - name: 'pagerduty'
    #   pagerduty_configs:
    #     - service_key: 'YOUR_PAGERDUTY_SERVICE_KEY'
    #       send_resolved: true
