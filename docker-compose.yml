# =============================================================================
# Kraken Regime Trading Bot - Docker Compose
# =============================================================================
# Simplified setup for running the trading bot with essential services
# Compatible with x86_64 and ARM64 (Raspberry Pi)
# =============================================================================

services:
    # =============================================================================
    # Redis - Data caching and state management
    # =============================================================================
    redis:
        image: redis:7-alpine
        container_name: kraken-redis
        restart: unless-stopped
        command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
        ports:
            - "${REDIS_PORT:-6379}:6379"
        volumes:
            - redis-data:/data
        networks:
            - kraken-network
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 10s
            timeout: 5s
            retries: 3
        deploy:
            resources:
                limits:
                    cpus: "0.5"
                    memory: 256M

    # =============================================================================
    # Kraken Trading Bot - Main application
    # =============================================================================
    kraken-bot:
        build:
            context: .
            dockerfile: docker/rust/Dockerfile
        container_name: kraken-bot
        restart: unless-stopped
        depends_on:
            redis:
                condition: service_healthy
        env_file:
            - .env
        environment:
            # Bot configuration
            - RUST_LOG=${RUST_LOG:-info}
            - RUST_BACKTRACE=1
            - TZ=${TZ:-America/New_York}

            # Redis connection
            - REDIS_URL=redis://redis:6379

            # Trading configuration
            - TRADING_PAIRS=${TRADING_PAIRS:-BTC/USD,ETH/USD}
            - INITIAL_CAPITAL=${INITIAL_CAPITAL:-10000}
            - RISK_PER_TRADE=${RISK_PER_TRADE:-0.01}
            - UPDATE_INTERVAL_SECS=${UPDATE_INTERVAL_SECS:-300}

            # Safety settings
            - ENABLE_DRY_RUN=${ENABLE_DRY_RUN:-true}
            - SIGNAL_ONLY_MODE=${SIGNAL_ONLY_MODE:-true}

            # Data directories
            - OHLC_DATA_DIR=/app/data/ohlc
            - OPTIMIZED_PARAMS_DIR=/app/data/params
        volumes:
            - kraken-data:/app/data
            - kraken-logs:/app/logs
        networks:
            - kraken-network
        deploy:
            resources:
                limits:
                    cpus: "1.0"
                    memory: 512M
                reservations:
                    cpus: "0.5"
                    memory: 256M
        logging:
            driver: "json-file"
            options:
                max-size: "10m"
                max-file: "3"
        healthcheck:
            test: ["CMD-SHELL", "pgrep -f kraken || exit 1"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 30s

# =============================================================================
# Networks
# =============================================================================
networks:
    kraken-network:
        driver: bridge

# =============================================================================
# Volumes - Persistent data storage
# =============================================================================
volumes:
    redis-data:
        name: kraken-redis-data
    kraken-data:
        name: kraken-bot-data
    kraken-logs:
        name: kraken-bot-logs
